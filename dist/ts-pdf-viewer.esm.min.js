import{GlobalWorkerOptions as e,getDocument as t}from"pdfjs-dist";class n{}n.V_CONTAINER_CLASS="ts-pdf-viewer-container",n.V_CONTAINER_HIDE_PANELS_CLASS="panels-hidden",n.V_PANEL_TOP_CLASS="ts-pdf-viewer-panel-top",n.V_PANEL_BOTTOM_CLASS="ts-pdf-viewer-panel-bottom",n.P_CONTAINER_CLASS="ts-pdf-page-container",n.P_CANVAS_CLASS="ts-pdf-page-canvas";var s=function(e,t,n,s){return new(n||(n=Promise))((function(i,a){function r(e){try{d(s.next(e))}catch(e){a(e)}}function o(e){try{d(s.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,o)}d((s=s.apply(e,t||[])).next())}))};class i{constructor(t,n){this._pageCanvases=[],this._pagesVisible=new Set,this.onPdfLoadingProgress=e=>{console.log(`${e.loaded}/${e.total}`)},this.onPdfLoaded=e=>{this._pdfDocument=e,this.refreshPageCanvases(),this.refreshPageView()},this.refreshPageView=()=>{this._pagesVisible=this.getVisiblePages(this._container,this._pageCanvases),this._pageCurrent=this.getCurrentPage(this._container,this._pageCanvases,this._pagesVisible),this.renderVisiblePagesAsync()};const s=document.querySelector(t);if(!s)throw new Error("Container not found");if(!(s instanceof HTMLDivElement))throw new Error("Container is not a DIV element");if(this._container=s,!n)throw new Error("Worker source path not defined");e.workerSrc=n,this.initViewerGUI()}destroy(){}openPdfAsync(e){return s(this,void 0,void 0,(function*(){if(this._pdfLoadingTask)return yield this.closePdfAsync(),this.openPdfAsync(e);const n=t(e);this._pdfLoadingTask=n,n.onProgress=this.onPdfLoadingProgress;const s=yield n.promise;this._pdfLoadingTask=null,this.onPdfLoaded(s)}))}closePdfAsync(){return s(this,void 0,void 0,(function*(){this._pdfLoadingTask&&(this._pdfLoadingTask.destroyed||(yield this._pdfLoadingTask.destroy()),this._pdfLoadingTask=null),this._pdfDocument&&(this._pdfDocument=null),this.refreshPageCanvases()}))}initViewerGUI(){const e=document.createElement("div");e.classList.add(n.V_CONTAINER_CLASS);const t=document.createElement("div");t.classList.add(n.P_CONTAINER_CLASS);const s=document.createElement("div");s.classList.add(n.V_PANEL_TOP_CLASS);const i=document.createElement("div");i.classList.add(n.V_PANEL_BOTTOM_CLASS),e.append(s),e.append(t),e.append(i),this._container.append(e),this._viewerContainer=e,this._pagesContainer=t}refreshPageCanvases(){var e;this._pageCanvases.forEach((e=>{e.canvas.remove()})),this._pageCanvases.length=0;const t=null===(e=this._pdfDocument)||void 0===e?void 0:e.numPages;t||this._pagesContainer.removeEventListener("scroll",this.refreshPageView);for(let e=0;e<t;e++){const e=document.createElement("canvas");e.classList.add(n.P_CANVAS_CLASS),e.height=500,this._pagesContainer.append(e),this._pageCanvases.push({canvas:e,ctx:e.getContext("2d"),rendered:!1,renderTask:null})}this._pagesContainer.addEventListener("scroll",this.refreshPageView)}renderVisiblePagesAsync(){return s(this,void 0,void 0,(function*(){const e=this._pdfDocument,t=this._pageCanvases,n=this._pagesVisible,s=Math.max(Math.min(...n)-2,0),i=Math.min(Math.max(...n)+2,t.length-1);for(let n=0;n<t.length;n++)n>=s&&n<=i?t[n].rendered||(yield this.renderPageAsync(e,t,n)):t[n].rendered&&this.clearRenderedPage(t,n)}))}getVisiblePages(e,t){const n=e.getBoundingClientRect(),s=n.top,i=n.top+n.height,a=new Set;return t.forEach(((e,t)=>{const n=e.canvas.getBoundingClientRect(),r=n.top,o=n.top+n.height;r<i&&o>s&&a.add(t)})),a}getCurrentPage(e,t,n){const s=[...n];if(!s.length)return 0;if(1===s.length)return s[0];const i=e.getBoundingClientRect(),a=i.top,r=i.top+i.height/2;for(const e of s){const n=t[e].canvas.getBoundingClientRect().top;if(n>a)return n>r?e-1:e}throw new Error("Incorrect argument")}renderPageAsync(e,t,n,i=1){return s(this,void 0,void 0,(function*(){const s=t[n];if(s.renderTask)return;const a=yield e.getPage(n+1),r=a.getViewport({scale:i});if(s.canvas.width=r.width,s.canvas.height=r.height,!s.renderTask){const e={canvasContext:s.ctx,viewport:r},t=a.render(e);s.renderTask=t,yield t.promise,s.renderTask=null,s.rendered=!0}}))}clearRenderedPage(e,t){const n=e[t];n.ctx.clearRect(0,0,n.canvas.width,n.canvas.height),n.rendered=!1}}export{i as TsPdfViewer};
